<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEDTRIX | Q-Bank Engine</title>
    
    <script src="config.js"></script> 
    <script src="medtrix_core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- MEDTRIX PRO THEME (RESTORED) --- */
        :root {
            --bg-body: #f4f7f6;
            --bg-grad: linear-gradient(135deg, #f4f7f6 0%, #eef2f3 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(0, 0, 0, 0.05);
            --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            
            --text-main: #1f2937;
            --text-sub: #6b7280;
            
            --accent: #007bff; 
            --accent-light: rgba(0, 123, 255, 0.1);
            --accent-grad: linear-gradient(135deg, #007bff, #0056b3);
            
            --success: #10b981; 
            --danger: #ef4444; 
            --radius: 16px;
        }

        /* DARK MODE REMOVED AS REQUESTED */

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-body); background-image: var(--bg-grad);
            background-attachment: fixed; color: var(--text-main);
            min-height: 100vh; padding: 20px;
            
            /* FIXED: PREVENT HORIZONTAL SCROLL WOBBLE */
            width: 100%;
            overflow-x: hidden;      
            overscroll-behavior-x: none;
            position: relative;
        }

        /* --- HEADER & SEARCH --- */
        .search-wrapper { max-width: 600px; margin: 25px auto 0; position: relative; }

        .search-wrapper input {
            width: 100%; padding: 16px 20px 16px 50px;
            border-radius: 50px; 
            border: 2px solid transparent;
            background: var(--glass-bg); 
            color: var(--text-main); 
            caret-color: var(--accent);
            backdrop-filter: blur(10px); outline: none; font-size: 1rem; font-weight: 500;
            box-shadow: var(--glass-shadow); transition: 0.3s;
        }

        .search-wrapper input:focus { 
            border-color: var(--accent); 
            box-shadow: 0 0 0 4px var(--accent-light); 
        }

        .search-wrapper i { 
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%); 
            color: var(--text-sub); pointer-events: none;
        }

        header { text-align: center; margin-bottom: 40px; }
        h1 { 
            font-family: 'Orbitron', sans-serif; font-size: 2rem; margin: 10px 0; 
            background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* --- GRID SYSTEM --- */
        .grid-view { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 20px; max-width: 1000px; margin: 0 auto 80px; 
        }

        .card {
            background: var(--glass-bg); border: var(--glass-border);
            border-radius: var(--radius); padding: 25px 15px;
            text-align: center; cursor: pointer;
            box-shadow: var(--glass-shadow); transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px;
            min-height: 160px;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }

        .card i { 
            font-size: 2.5rem; color: var(--text-sub); transition: 0.3s; 
            background: var(--accent-light);
            width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
        }
        .card:hover i { color: #fff; background: var(--accent); transform: scale(1.1); }
        .card h3 { font-size: 0.95rem; font-weight: 600; margin: 0; color: var(--text-main); }

        /* --- LIST VIEW --- */
        .list-view { display: flex; flex-direction: column; gap: 15px; max-width: 800px; margin: 0 auto; }
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--glass-bg); padding: 20px; border-radius: 15px;
            border: var(--glass-border); cursor: pointer; transition: 0.2s;
        }
        .list-item:hover { background: var(--accent-light); border-color: var(--accent); }
        .badge { background: var(--accent); color: #fff; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 0.8rem; }

        /* --- QUIZ UI --- */
        .quiz-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; font-family: 'Orbitron'; color: var(--text-sub);
        }

        .q-box {
            background: var(--glass-bg); border: var(--glass-border);
            border-radius: var(--radius); padding: 30px;
            box-shadow: var(--glass-shadow); margin-bottom: 100px;
            backdrop-filter: blur(15px);
        }
        .q-text { font-size: 1.15rem; font-weight: 600; margin-bottom: 25px; line-height: 1.6; }
        
        /* RESTORED: Original Simple Image Layout */
        .image-container { text-align: center; margin-bottom: 20px; display: block; }
        .q-img { 
            max-width: 100%; border-radius: 12px; 
            border: 1px solid var(--glass-border); cursor: zoom-in;
            margin: 5px; display: inline-block;
        }

        .option {
            padding: 18px; border: 2px solid transparent; border-radius: 14px;
            cursor: pointer; transition: 0.2s; margin-bottom: 12px;
            background: rgba(0,0,0,0.03); display: flex; gap: 15px; font-weight: 500;
            color: var(--text-main);
        }
        .option:hover { border-color: var(--accent); background: var(--accent-light); }
        .option.correct { border-color: var(--success); background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .option.wrong { border-color: var(--danger); background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .option.disabled { pointer-events: none; opacity: 0.7; }

        /* Explanation Box */
        .exp-box {
            margin-top: 20px; padding: 20px; border-radius: 12px;
            background: rgba(255,255,255,0.5); border: 1px solid var(--accent-light);
            display: none; animation: fadeIn 0.3s;
        }
        .exp-box.show { display: block; }
        
        /* TABLE FIX: Horizontal Scroll */
        .exp-content { 
            overflow-x: auto; 
            font-size: 0.95rem; line-height: 1.6;
        }
        .exp-content table { width: 100%; border-collapse: collapse; min-width: 400px; margin: 10px 0; }
        .exp-content td, .exp-content th { border: 1px solid #ddd; padding: 8px; }

        /* --- FOOTER & BUTTONS --- */
        .footer-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; background: var(--glass-bg);
            padding: 10px; border-radius: 40px; border: var(--glass-border);
            display: flex; gap: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            backdrop-filter: blur(20px); z-index: 50;
        }
        .btn { flex: 1; padding: 12px; border-radius: 30px; border: none; font-weight: 700; cursor: pointer; }
        .btn-nav { background: transparent; color: var(--text-main); }
        .btn-action { background: var(--accent); color: #fff; box-shadow: 0 4px 15px var(--accent-light); }

        /* --- HOME BUTTON (FIXED SMALL SIZE) --- */
        .medtrix-home-btn {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); /* Fixed border syntax */
            color: var(--text-main); box-shadow: var(--glass-shadow);
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); cursor: pointer;
            
            /* Compact Size */
            padding: 4px 12px; 
            border-radius: 15px; 
            font-size: 12px; 
            font-weight: 600; 
            gap: 4px; 
            text-decoration: none; 
        }

        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <a href="index.html" class="medtrix-home-btn" id="home-btn" style="display:none">
        <i class="fas fa-home"></i> Home
    </a>

    <header id="main-header">
        <div class="logo-box"><i class="fas fa-dna"></i></div>
        <h1>MEDTRIX</h1>
        <div class="version-tag">MEDICAL ENGINE V4.0</div>
        
        <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search Anatomy, Pharma, etc...">
        </div>
    </header>

    <div id="main-container" class="grid-view">
        </div>

    <div id="lightbox" class="hidden" onclick="this.classList.add('hidden')" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:2000; display:flex; justify-content:center; align-items:center;">
        <img id="lightbox-img" style="max-width:95%; max-height:95%; border-radius:8px;">
    </div>

<script>
    const App = {
        data: {
            subjects: [], syllabus: {}, cache: {},
            activeSubject: null, activeQuestions: [], currentQIndex: 0,
            sessionStats: { correct: 0, wrong: 0, total: 0 }
        },
        elements: {
            main: document.getElementById('main-container'),
            search: document.getElementById('searchInput'),
            lightbox: document.getElementById('lightbox'),
            lightboxImg: document.getElementById('lightbox-img'),
            header: document.getElementById('main-header'),
            homeBtn: document.getElementById('home-btn')
        },
        async init() {
            try {
                const [subRes, sylRes] = await Promise.all([
                    fetch('./data/subjects.json'), fetch('./data/syllabus.json')
                ]);
                this.data.subjects = await subRes.json();
                this.data.syllabus = await sylRes.json();
                window.addEventListener('hashchange', () => this.router());
                this.elements.search.addEventListener('input', (e) => this.handleSearch(e.target.value));
                this.router();
            } catch (error) {
                console.error(error);
                this.elements.main.innerHTML = `<div style="text-align:center; padding:50px; color:var(--danger)"><h3>Load Error</h3></div>`;
            }
        },
        async router() {
            const hash = window.location.hash.slice(1) || '/';
            const segments = hash.split('/');
            const isQuiz = segments[0] === 'quiz';
            
            // Toggle Header/Home Button based on view
            this.elements.header.style.display = isQuiz ? 'none' : 'block';
            this.elements.homeBtn.style.display = isQuiz ? 'flex' : 'none';

            if (hash === '/' || hash === '') { this.renderHome(); return; }
            if (segments[0] === 'subject') {
                const subName = decodeURIComponent(segments[1]);
                await this.loadSubjectData(subName);
                this.renderChapterList(subName);
                return;
            }
            if (segments[0] === 'quiz') {
                const subName = decodeURIComponent(segments[1]);
                const chapterIndex = segments[2];
                if (!this.data.cache[subName]) await this.loadSubjectData(subName);
                this.startQuiz(subName, chapterIndex);
                return;
            }
        },
        async loadSubjectData(name) {
            if (this.data.cache[name]) return;
            this.elements.main.innerHTML = `<div style="text-align:center; padding:50px;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`;
            const subjectObj = this.data.subjects.find(s => s.name === name);
            const fileName = subjectObj ? subjectObj.file : `${name}.json`;
            try {
                const res = await fetch(`./data/${fileName}`);
                this.data.cache[name] = await res.json();
            } catch (e) { alert(`Error loading: ${fileName}`); }
        },
        
        // --- CLEAN TEXT (FIXED FOR GREEK/ARROWS) ---
        cleanText(text) {
            if (!text) return "";
            const map = { 
                '≡': '→', '->': '→', 'â€“': '-', 'â€”': '—', 'â€™': "'", 
                'ï»¿': '', '': '•', '': '•', '': '≥', '': '≤', 
                '': '×', '': 'µ', '': '→', '°': '→' 
            };
            let clean = text.replace(/≡|->|â€“|â€”|â€™|ï»¿||||||||°/g, m => map[m]);
            clean = clean.replace(//g, "α").replace(//g, "β").replace(//g, "γ").replace(//g, "δ").replace(//g, "Δ").replace(//g, "θ");
            clean = clean.replace(/\ba\s?\((1)/g, "α($1"); 
            return clean;
        },

        renderHome() {
            this.elements.search.value = '';
            this.elements.main.className = 'grid-view'; 
            this.elements.main.innerHTML = this.data.subjects.map(sub => `
                <div class="card" onclick="location.hash = '#subject/${sub.name}'">
                    <i class="fa-solid ${this.getIcon(sub.name)}"></i>
                    <h3>${sub.name}</h3>
                </div>
            `).join('');
        },

        renderChapterList(subName) {
            this.elements.main.className = 'list-view';
            let chapters = this.data.syllabus[subName] || [];
            const allQuestions = this.data.cache[subName] || [];
            
            let html = `
                <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px">
                    <button onclick="location.hash='#/'" style="background:none; border:none; font-size:1.5rem; cursor:pointer;"><i class="fa-solid fa-chevron-left"></i></button>
                    <h2 style="font-family:'Orbitron'; margin:0;">${subName}</h2>
                </div>
                <div class="list-item" style="border-left: 4px solid var(--accent);" onclick="location.hash = '#quiz/${subName}/ALL'">
                    <div><div style="font-weight:bold;">FULL BANK</div></div>
                    <div class="badge">${allQuestions.length}</div>
                </div>`;

            html += chapters.map((title, idx) => {
                const chNum = idx + 1;
                const count = allQuestions.filter(q => q.id.includes(`_Ch${chNum}_`)).length;
                if(count === 0) return '';
                return `
                    <div class="list-item" onclick="location.hash = '#quiz/${subName}/${chNum}'">
                        <div><div style="opacity:0.6; font-size:0.8rem;">CHAPTER ${chNum}</div><div style="font-weight:600;">${this.cleanText(title)}</div></div>
                        <div class="badge" style="background:var(--bg-body); color:var(--text-main)">${count}</div>
                    </div>`;
            }).join('');
            this.elements.main.innerHTML = html;
        },

        startQuiz(subName, chNum) {
            this.data.activeSubject = subName;
            this.elements.main.className = '';
            this.data.sessionStats = { correct: 0, wrong: 0, total: 0 };
            this.data.activeQuestions = chNum === 'ALL' ? this.data.cache[subName] : this.data.cache[subName].filter(q => q.id.includes(`_Ch${chNum}_`));
            this.data.currentQIndex = 0;
            this.renderQuestion();
        },

        renderQuestion() {
            const q = this.data.activeQuestions[this.data.currentQIndex];
            const total = this.data.activeQuestions.length;
            const current = this.data.currentQIndex + 1;
            const isLast = current === total;

            // RESTORED: Standard Image Layout
            let imgHtml = '';
            if(q.images && q.images.length > 0) {
                imgHtml = `<div class="image-container">` + 
                    q.images.map(img => `<img src="./data/images/${img}" class="q-img" onclick="App.openImage(this.src)" onerror="this.style.display='none'">`).join('') +
                    `</div>`;
            }

            const html = `
                <div style="max-width:800px; margin:0 auto;">
                    <div class="quiz-header">
                        <button onclick="history.back()" style="background:none; border:none; cursor:pointer;">EXIT</button>
                        <span style="font-weight:bold; color:var(--accent);">${current} / ${total}</span>
                    </div>

                    <div class="q-box">
                        <div class="q-text">${this.cleanText(q.question_text)}</div>
                        ${imgHtml}
                        
                        <div style="margin-top:20px;">
                            ${q.options.map((opt, i) => `
                                <div class="option" onclick="App.handleAnswer(this, ${i}, '${q.correct_option}')">
                                    <span style="color:var(--accent); font-weight:bold;">${String.fromCharCode(65 + i)}</span>
                                    <span>${this.cleanText(opt)}</span>
                                </div>
                            `).join('')}
                        </div>

                        <div id="explanation" class="exp-box">
                            <div style="font-weight:bold; color:var(--accent); margin-bottom:10px;">EXPLANATION</div>
                            <div class="exp-content">${this.cleanText(q.explanation)}</div>
                        </div>
                    </div>
                </div>

                <div class="footer-bar">
                    <button class="btn btn-nav" onclick="App.navQuestion(-1)"><i class="fa-solid fa-arrow-left"></i></button>
                    <button class="btn btn-action" onclick="${isLast ? 'App.finishQuiz()' : 'App.navQuestion(1)'}">${isLast ? 'FINISH' : 'NEXT'}</button>
                </div>
            `;
            this.elements.main.innerHTML = html;
            window.scrollTo(0,0);
        },

        handleAnswer(el, index, correctChar) {
            if (el.classList.contains('disabled')) return;
            const parent = el.parentElement;
            const options = parent.children;
            const selectedChar = String.fromCharCode(97 + index); 
            const correctIndex = correctChar.toLowerCase().charCodeAt(0) - 97;

            this.data.sessionStats.total++;
            if (selectedChar === correctChar.toLowerCase()) {
                el.classList.add('correct');
                this.data.sessionStats.correct++;
            } else {
                el.classList.add('wrong');
                this.data.sessionStats.wrong++;
                if(options[correctIndex]) options[correctIndex].classList.add('correct');
            }
            Array.from(options).forEach(opt => opt.classList.add('disabled'));
            document.getElementById('explanation').classList.add('show');
            
            // Auto Scroll
            if(window.innerWidth < 768) setTimeout(() => document.getElementById('explanation').scrollIntoView({behavior:'smooth'}), 200);
            
            // Save to Core
            try { if(MEDTRIX && MEDTRIX.db) MEDTRIX.db.saveResult(this.data.activeQuestions[this.data.currentQIndex], (selectedChar === correctChar.toLowerCase()), this.data.activeSubject); } catch(e) {}
        },

        navQuestion(dir) {
            const newIndex = this.data.currentQIndex + dir;
            if (newIndex >= 0 && newIndex < this.data.activeQuestions.length) {
                this.data.currentQIndex = newIndex;
                this.renderQuestion();
            }
        },

        finishQuiz() {
            // Basic Finish Screen logic would go here
            location.reload(); 
        },

        handleSearch(query) {
            if(window.location.hash !== '' && window.location.hash !== '#/') return;
            if(query.length < 2) { this.renderHome(); return; }
            const filtered = this.data.subjects.filter(s => s.name.toLowerCase().includes(query.toLowerCase()));
            this.elements.main.className = 'grid-view';
            this.elements.main.innerHTML = filtered.map(sub => `
                <div class="card" onclick="location.hash = '#subject/${sub.name}'">
                    <i class="fa-solid ${this.getIcon(sub.name)}"></i>
                    <h3>${sub.name}</h3>
                </div>
            `).join('');
        },
        
        openImage(src) { this.elements.lightboxImg.src = src; this.elements.lightbox.classList.remove('hidden'); },

        getIcon(name) {
            const map = { 'anatomy': 'fa-bone', 'physiology': 'fa-heart-pulse', 'biochemistry': 'fa-dna', 'pathology': 'fa-disease', 'pharmacology': 'fa-pills', 'medicine': 'fa-user-doctor', 'surgery': 'fa-scalpel', 'pediatrics': 'fa-baby', 'obg': 'fa-person-pregnant' };
            return map[name.toLowerCase().trim()] || 'fa-book-medical';
        }
    };

    window.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
